
{% extends "base.html" %}

{% block bo_dy %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js" integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA==" crossorigin="anonymous"></script>
<script src="/static/main.js"></script>
<script src="/static/snippet.js"></script>
<script>
  $(document).ready(async () => {
    //checking topic
    const TopicData = await (await fetch(`/api/topic?TopicId=${getQueryParam("id")}`)).json();

    if (TopicData.length === 0) {
      document.location.href = "/topic/create";
    }

    const TopicInfoVar = $("#TopicInfo");
    const TopicHTML = $(`<p> ${TopicData.time}|${TopicData.theme}|${TopicData.author}|${TopicData.about} </p>`);
    TopicInfoVar.append(TopicHTML);

    //defining socket var
    const socket = io();

    //handling start of connection
    socket.on("connect", () => {
      console.log("WebSockets connection established");
    });

    //handling incoming messages
    socket.on("NewMessage", (data) => {
      if (data.TopicId === getQueryParam("id")) {
        fetch(`/api/user?UserId=${data.author}`)
          .then((r) => r.json())
          .then((userData) => {
            console.log(userData);
            return MsgSnippet(userData, data);
          })
          .then((msg) => {
            $("#Msgs").append(msg);
          });
      }
    });

    socket.on("TopicDelete", (data) => {
      if (data.TopicId === getQueryParam("id")) {
        document.location.href = "/";
      }
    });

    socket.on("MsgDel", (data) => {
      if (data.TopicId === getQueryParam("id")) {
        $(data.MessageId).remove();
      }
    });

    //loading message in topic via message and user API
    fetch(`/api/messages?TopicId=${getQueryParam("id")}`)
      .then((response) => response.json())
      .then((jsonData) => {
        jsonData.forEach((element) => {
          fetch(`/api/user?UserId=${element.author}`)
            .then((r) => r.json())
            .then((userData) => {
              return MsgSnippet(userData, element);
            })
            .then((msg) => {
              $("#Msgs").append(msg);
            });
        });
      })
      .catch((error) => {
        console.error("Error fetching messages:", error);
      });

    async function DeleteMessage(MsgId, token) {
      const data = JSON.stringify({ JWToken: token, MessageId: MsgId });
      socket.emit("MessageDelete", data);
    }

    async function DeleteTopic(UserToken, TopicId) {
      const data = JSON.stringify({ TopicId: TopicId, token: UserToken });
      socket.emit("TopicDelete", data);
    }

    //sending message
    $("#MsgForm").submit((e) => {
      e.preventDefault();
      if (IsLogged(getCookie("token")) && $("#MsgForm").find('input[name="Message"]').val() !== "") {
        const TopicId = getQueryParam("id");
        const AuthToken = getCookie("token");
        const message = $("#MsgForm").find('input[name="Message"]').val();
        socket.emit(
          "message",
          JSON.stringify({
            JWToken: AuthToken,
            TopicId: TopicId,
            message: message,
          })
        );
        $("#MsgForm").find('input[name="Message"]').val("");
      } else {
        alert("please, log in or type your message");
      }
    });
  });
</script>

<p style="color:red;" id="error"></p>
<form method="POST" enctype="multipart/form-data" id="MsgForm">
  Write your message
  <input name="Message" type="text">
  <input type="submit" value="Send Message">
</form>
<button onclick="DeleteTopic( getCookie('token'), getQueryParam('id') )">delete topic</button>
<div class="navigate">
  <span id="TopicInfo"></span>
</div>

<div id="Msgs"></div>

<hr>


{% endblock bo_dy %}
